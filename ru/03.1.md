# Принципы работы Web

Каждый раз, когда Вы открываете браузер, набираете URL и нажимаете enter, на экране появляется красивая Web страница. Но знаете ли вы, что стоит за этим простым действием? 

Обычно, ваш браузер является клиентом . После того как вы набрали URL, браузер берёт имя хоста (домен) из URL и посылает на DNS сервер, чтобы получить IP адрес хоста. Затем, браузер соединяется с полученным IP адресом и запрашивает установку  TCP соединения, чтобы послать НТТР запросы (requests) через это соединение. Сервер обрабатывает их и отсылает  HTTP ответы (responses), в которых содержится информация для построения Web страницы. В итоге, браузер обрабатывает тело веб-страницы и разъединяется с сервером.

![](images/3.1.web2.png?raw=true)

3.1 Процесс посещения полбзователем web-сайта

Веб-сервер, также известный как сервер HTTP, использует протокол HTTP для связи с клиентами. Все веб-браузеры можно считать клиентами.

Мы можем разделить принципы работы web на следующие шаги:

- Клиент использует протокол TCP/IP, чтобы соединиться с сервером.
- Клиент отправляет пакеты запроса HTTP (request),  серверу.
- Сервер возвращает пакеты ответа HTTP (response),  клиенту. Если запрашиваемые ресурсы включают динамические сценарии, сначала сервер вызывает механизм выполнения сценария.
- Клиент отключается от сервера, начинает обработку HTML.

Это - простой ход процессов HTTP. Обратите внимание, что сервер закрывает свои соединения после того, как он отправляет данные клиентам, затем ожидает следующего запроса.

## URL и DNS (Разрешение доменных имён)

Мы всегда используем URL, чтобы получить доступ к веб-страницам, но знаетели вы, как устроен URL ?

URL - Единый указатель ресурсов. Используется для описания ресурсов в интернете , основная форма записи URL прдеставлена ниже:

    scheme://host[:port#]/path/.../[?query-string][#anchor]
	  scheme         используемый протокол (HTTP, HTTPS, FTP)
	  host           IP или доменное имя HTTP сервера
	  port#          порт по умолчанию 80, не обязателен для ввода если не менять. Если вам необходимо использовать другой порт, необходимо переопределить его. Например: http://www.cnblogs.com:8080/
	  path           путь к запрашиваему русурсу
	  query-string   строка запроса с передаваемыми на сервер (методом GET) параметрами
	  anchor         идентификатор «якоря», ссылающегося на некоторую часть (раздел) открываемого документа

DNS. Domain Name System — система доменных имён. Это - система именования в компьютерной сети, которая преобразовывает доменные имена в фактические IP-адреса.

![](images/3.1.dns_hierachy.png?raw=true)

3.2 Принципы работы DNS

Чтобы лучше понять принципе работы DNS, давайте посмотрим подробный процесс разрешения доменных имен.

1. После введения доменного имени www.qq.com в браузере, операционная система проверит, есть ли запись этого доменного имени в  фаиле «hosts» . Если так, тогда преобразование доменного имени в ip адрес будет согласно содержимому файла «hosts» .
2. Если никаких записей о доменном имени  в файле «hosts" нет, то операционная система проверит, наличие имени домена  в кэш DNS операционной системы. Если есть, тогда преобразование доменного имени будет согласно содержимому  кэша DNS.
3. Если нет никаких записей с искомым доменным именем в файле Hosts и в кэше DNS операционной системы, то операционная система обращается к DNS серверу записанному в ваших настройках TCP/IP, который вероятно является вашим локальный сервером DNS. Когда локальный DNS-сервер получает запрос и если имя домена, которое вы запрашиваете содержится в локальной конфигурации, региональных ресурсов, он возвращает результаты клиенту. Это разрешение DNS является авторитетным.
4. Если локальный DNS-сервер не содержит имя домена, но сопоставление отношений существует в кэше этого сервера, локальный DNS-сервер возвращает результат клиенту. Это разрешение DNS не является авторитетным.
5. Если локальный DNS сервер не может найти доменное имя, то далее он переходит к следующему шагу, который зависит от настройки локального DNS-сервера.
-Если на локальном DNS-сервере не включена  переадресация, он направляет запрос на корневой DNS-сервер, этот сервер возвращает IP-адрес DNS-сервера верхнего уровня, который  является ответственным за зону ".com" в данном случае. Если первый DNS сервер верхнего уровня не распознает доменное имя, он перенаправляет запросов к следующему DNS серверу верхнего уровня и так до тех пор, пока доменное имя не будет распознано. Затем сервер DNS верхнего уровня, запрашивает у DNS сервера распознавшего доменное имя, "ip" адрес соответствующий «www.qq.com» 
-Если у локального сервера DNS включена переадресация ...

Независимо от того, позволяет ли локальный сервер DNS переадресацию, IP-адрес доменного имени всегда возвращается к локальному серверу DNS, и локальный сервер DNS передает его обратно клиенту.

![](images/3.1.dns_inquery.png?raw=true)

3.3 Цепь DNS разрешений

DNS-запрос может быть `рекурсивным` — требующим полного поиска, — и нерекурсивным или `итеративным` — не требующим полного поиска.

Теперь мы знаем, что клиенты получают IP-адреса в итоге, таким образом, браузеры связываются с серверами через IP-адреса.

## HTTP протокол

Протокол HTTP является основной частью веб-сервисов. Важно знать, что такое «HTTP протокол»  прежде, чем вы поймете, как работает «WEB».

HTTP протокол, используется для облегчения связи между браузерами и веб-серверами. Он основан на протоколе TCP, и обычно использует порт 80 на стороне сервера. HTTP это протокол, который использует модель запрос-ответ (requests-response), клиенты оправляют запросы (request) , а серверы отвечают (response). Согласно протоколу HTTP, клиенты всегда устанавливают новые соединения и отправляют запросы HTTP к серверам. Серверы не в состоянии соединиться с клиентами самостоятельно или совершить обратный вызов. Соединение между клиентом и сервером может быть закрыто любой стороной. Например, вы можете отменить ваш запрос на скачивание, тогда http-соединение и браузер будут отключены от сервера до завершения загрузки. 

HTTP не сохраняет своего состояния, это означает, что сервер понятия не имеет об отношении между двумя соединениями даже при том, что они оба от одного  клиента. Чтобы решить эту проблему, веб-приложения используют файлы cookie для отслеживания состояния соединения.
 
Поскольку http-протокол, основанный на TCP протоколе, то все атаки на TCP повлияют на http-соединения на вашем сервере. Примерами таких атак являются SYN flooding, DOS и DDoS-атаки.

### HTTP запрос (request от браузера)

Все HTTP запросы состоят из трех частей:  request line - строка запроса, request header - заголовок запроса, body -тело запроса. Также есть одна пустая строка между заголовком и телом запроса.

    GET /domains/example/ HTTP/1.1      // строка запроса: метод, URL, протокол и верси
  	Host：www.iana.org             // имя домена
  	User-Agent：Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.4 (KHTML, like Gecko) Chrome/22.0.1229.94 Safari/537.4            // информация о браузере
  	Accept：text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8    // mime типы которые клиент может принять
  	Accept-Encoding：gzip,deflate,sdch     // метод сжатия
  	Accept-Charset：UTF-8,*;q=0.5      // кодировка клиента
  	// blank line                       пустая строка
  	// body                           аргументы запроса (атуально для POST запроса)

Мы используем программу «Fiddler» чтобы получить информацию о запросе.

![](images/3.1.http.png?raw=true)

3.4 Запрос GET полученный в программе fiddler

![](images/3.1.httpPOST.png?raw=true)

3.5 Запрос POST полученный в программе fiddler

**Мы видим, что GET запросы не имеют тело запроса (body), в отличие от POST запросов, в которых содержится тело запроса.**

В HTTP есть много методов для связи с серверами. GET, POST, PUT и DELETE это основные 4 методы которые мы используем. URL-адрес представляет собой ресурс в сети, методы:  изменить, добавить, удалить (GET, POST, PUT и DELETE) передаются в запросе и определяют действие над ресурсом в сети. GET и POST очень часто используются в HTTP. Используя GET можно добавлять параметры запроса к URL, используя знак `?`, разделяя URL и параметры. А знак `&` разделяет аргументы. Например: `GET /path/resource?param1=value1&param2=value2` POST помещает данные в тело запроса (body), т.к. URL имеет ограниченную длину.Таким образом POST может передать намного больше данных, чем GET. Кроме того, когда мы передаем информацию содержащую имена пользователей и пароли, не желательно, чтоб это отображалось в URL, при использование POST информация передается скрытой в теле запроса.

### HTTP ответ (response от сервера)

Давайте посмотрим, какая информация содержится в пакетах ответа (response).

    HTTP/1.1 200 OK                     // status line
  	Server: nginx/1.0.8                 // web server software and its version in the server machine
  	Date:Date: Tue, 30 Oct 2012 04:14:25 GMT        // responded time
  	Content-Type: text/html             // responded data type
  	Transfer-Encoding: chunked          // it means data were sent in fragments
  	Connection: keep-alive              // keep connection 
  	Content-Length: 90                  // length of body
  	// blank line
  	<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"... // message body

Первая строка это строка состояния (status line)  Показывает версию HTTP. Код и сообщение состояния. 

Код состояния сообщает клиенту ,  о результатах его запроса на сервер. В HTTP/1.1 были определены 5 видов кодов состояния:

        - 1xx Informational Информационный
        - 2xx Success		    Успех
        - 3xx Redirection	  Перенаправление
        - 4xx Client Error	Ошибка клиента
        - 5xx Server Error	Ошибка сервера

Давйте посмотрим еще несколько примеров "ответов" (response). Код 200 сообщает об успешной обработке запроса клиента, 300 означает перенаправление запроса.

![](images/3.1.response.png?raw=true)

3.6 Иформация о посещенном web-сайте

### HTTP не сохраняет своего состояния.  Постоянное соединение.

Термин, не сохраняет своего состояния, не означает, что сервер не может сохранить соединение. Это просто означает, что сервер не распознает связь между любыми двумя запросами. 

В HTTP/1.1 Постоянное соединение (keep-ilive) используется по умолчанию. Если у клиентов будут дополнительные запросы, то они будут использовать то же соединение для них.

Заметьте , что постоянное соединение (keep-alive) не может поддерживать одно соединение навсегда . Приложение работающие на сервере, определяет придел , в течении которого можно поддерживать соединение. В большинстве случаев это настраиваемый параметр.

## Экземпляр запроса (request)

![](images/3.1.web.png?raw=true)

3.7 All packages for opening one web page

Мы можем видеть весь процесс коммуникации между клиентом и сервером в вышеприведенном рисунке. Вы можете заметить, что есть много файлов ресурсов в списке, они называются статические файлы. В Go есть специальные методы для обработки этих файлов.

Это - главная функция браузеров: запросить через URL и получить данные от веб-серверов,  а затем обработать HTML. Если в DOM, html страницы браузер найдет файлы CSS или JS, то браузер снова будет отправлять запросы на сервер, пока все ресурсы не будут полученны и обработанны для отображения на экране.

Сокращение времени запросов, является одним из способов ускорить загрузку веб-страниц. Сокращая количество CSS и JS файлов которые должны быть загруженны, сократится время задержек на запросы, а также сократится нагрузка на ваши веб-сервера.

## Links

- [Directory](preface.md)
- Previous section: [Web foundation](03.0.md)
- Next section: [Build a simple web server](03.2.md)




























































